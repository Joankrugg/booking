<div class="calendar-page">
  <div class="calendar-shell">

    <!-- HERO -->
    <div class="calendar-hero-inner">
      <h1>Que voulez-vous faire ?</h1>
      <p>Sélectionnez vos envies, choisissez une date, découvrez les disponibilités.</p>
    </div>

    <!-- FILTRES -->
    <div class="filters-chips">
      <% @categories.each do |category| %>
        <label class="filter-chip">
          <input type="checkbox"
                 class="category-filter"
                 value="<%= category.id %>"
                 <%= "checked" if @selected_categories.include?(category.id) %>>

          <span class="chip-label">
            <%= category.name %>
          </span>
        </label>
      <% end %>
    </div>


    <!-- CALENDRIER -->
    <div class="calendar-filter">
      <div class="calendar-header">
        <%= link_to "‹",
              calendar_path(date: @date.prev_month.beginning_of_month),
              class: "month-nav" %>

        <strong><%= @date.strftime("%B %Y") %></strong>

        <%= link_to "›",
              calendar_path(date: @date.next_month.beginning_of_month),
              class: "month-nav" %>
      </div>

      <div class="calendar-grid">
        <% @calendar_days.each do |day| %>
          <%= link_to calendar_path(date: day[:date], categories: @selected_categories.presence), class: "day calendar-day-link #{'active' if day[:date] == @date}" do %>

            <span class="day-number"><%= day[:date].day %></span>
            <% if day[:available] %>
              <span class="day-dot"></span>
            <% end %>
          <% end %>
        <% end %>
      </div>
    </div>

    <!-- RÉSULTATS -->
    <div class="calendar-results">
      <% if @slots_by_service.present? %>
        <% @slots_by_service.each do |service, slots| %>
          <div class="activity-card">
            <div class="activity-body">
              <h3><%= service.name %></h3>
              <div class="activity-meta">
                <%= service.duration_minutes %> min · <%= service.price_euros %> €
              </div>

              <div class="activity-slots">
                <% slots.each do |slot| %>
                  <%= link_to slot[:start].strftime("%H:%M"),
                      new_service_booking_path(
                        service,
                        start_time: slot[:start],
                        end_time: slot[:end]
                      ),
                      class: "slot-pill" %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      <% else %>
        <p class="empty-state">
          Cliquez sur une date pour voir les disponibilités.
        </p>
      <% end %>
    </div>

  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
  const categoryInputs = document.querySelectorAll(".category-filter");
  const dayLinks = document.querySelectorAll(".calendar-day-link");

  function selectedCategories() {
    return Array.from(categoryInputs)
      .filter(cb => cb.checked)
      .map(cb => `categories[]=${cb.value}`)
      .join("&");
  }

  dayLinks.forEach(link => {
    link.addEventListener("click", (e) => {
      e.preventDefault();

      const baseUrl = link.getAttribute("href");
      const categories = selectedCategories();

      const targetUrl = categories ? `${baseUrl}&${categories}` : baseUrl;
      window.location.href = targetUrl;
    });
  });
});
</script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const categoryInputs = document.querySelectorAll(".category-filter");

    categoryInputs.forEach(input => {
      input.addEventListener("change", () => {
        const params = new URLSearchParams(window.location.search);

        // On enlève toutes les catégories
        params.delete("categories[]");

        // On remet celles cochées
        categoryInputs.forEach(cb => {
          if (cb.checked) {
            params.append("categories[]", cb.value);
          }
        });

        // On conserve la date si elle existe
        const date = params.get("date");
        const base = date ? `/calendar?date=${date}` : "/calendar";

        const targetUrl =
          params.toString().includes("categories")
            ? `${base}&${params.toString()}`
            : base;

        window.location.href = targetUrl;
      });
    });
  });
</script>