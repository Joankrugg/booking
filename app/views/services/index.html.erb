<div class="container py-5">
  <h1 class="mb-4 fw-bold">Prestations disponibles</h1>

  <div class="row g-4">
    <% @services.each do |service| %>
      <div class="col-md-4">
        <div class="card shadow-sm service-card" data-service-id="<%= service.id %>">

          <% if service.photo.attached? %>
            <%= image_tag service.photo, class: "card-img-top", style: "height:180px; object-fit:cover;" %>
          <% else %>
            <div class="bg-light d-flex align-items-center justify-content-center" style="height:180px;">
              <span class="text-muted">Aucune image</span>
            </div>
          <% end %>

          <div class="card-body">
            <h5 class="fw-bold"><%= service.name %></h5>
            <p class="text-muted"><%= truncate(service.description, length: 90) %></p>

            <p class="fw-semibold mb-2">
              <%= service.price_euros %> € • <%= service.duration_minutes %> min
            </p>

            <!-- Flatpickr date -->
            <div data-controller="flatpickr">
              <input type="text" data-flatpickr-target="input" class="form-control public-date-picker">
            </div>

            <!-- Slots results -->
            <div class="public-slots small border rounded p-2 bg-light" style="min-height:55px;">
              <span class="text-muted">Sélectionnez une date pour voir les créneaux.</span>
            </div>

            <div class="mt-3">
              <%= link_to "Voir la fiche", service_path(service), class: "btn btn-outline-primary btn-sm" %>
            </div>

          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
<style>
  .service-card {
    border-radius: 16px;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .service-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
  }
</style>


<script>
document.addEventListener("turbo:load", initFlatpickr);
document.addEventListener("turbo:render", initFlatpickr);

function initFlatpickr() {
  document.querySelectorAll(".service-card").forEach(function (card) {

    // éviter double init
    if (card.classList.contains("fp-loaded")) return;
    card.classList.add("fp-loaded");

    const serviceId   = card.dataset.serviceId;
    const dateInput   = card.querySelector(".public-date-picker");
    const slotsBox    = card.querySelector(".public-slots");

    if (!dateInput) return;

    flatpickr(dateInput, {
      dateFormat: "Y-m-d",
      minDate: "today",
      onChange: function(selectedDates, dateStr) {
        if (!dateStr) return;
        loadSlots(serviceId, dateStr, slotsBox);
      }
    });
  });
}


function loadSlots(serviceId, date, container) {
  container.innerHTML = "<span class='text-muted'>Chargement...</span>";

  fetch(`/services/${serviceId}/availability?date=${encodeURIComponent(date)}`)
    .then(res => res.json())
    .then(data => {
      renderSlots(data.slots || [], date, serviceId, container);
    })
    .catch(() => {
      container.innerHTML = "<span class='text-danger'>Erreur lors du chargement.</span>";
    });
}

function renderSlots(slots, date, serviceId, container) {
  if (slots.length === 0) {
    container.innerHTML = "<span class='text-muted'>Aucun créneau ce jour-là.</span>";
    return;
  }

  let html = "<div class='d-flex flex-wrap gap-1'>";

  slots.forEach(slot => {
    const label = new Date(slot.start).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});

    html += `
      <a href="/services/${serviceId}?date=${date}&start=${slot.start}"
         class="btn btn-sm btn-outline-primary">
         ${label}
      </a>
    `;
  });

  html += "</div>";

  container.innerHTML = html;
}
</script>



