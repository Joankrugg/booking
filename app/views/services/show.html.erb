<!-- app/views/services/show.html.erb -->
<div class="row">
  <div class="col-md-6 mb-4">
    <h1 class="h3"><%= @service.name %></h1>
    <p><%= @service.description %></p>

    <p class="fw-bold">
      <%= @service.price_euros %> € · <%= @service.duration_minutes %> minutes
    </p>
  </div>

  <div class="col-md-6 mb-4">
    <h2 class="h4 mb-3">Réserver un créneau</h2>

    <!-- Sélecteur de date -->
    <div class="mb-3">
      <label for="booking-date" class="form-label">Date</label>
      <input type="date" id="booking-date" class="form-control">
    </div>

    <!-- Créneaux disponibles -->
    <div class="mb-3">
      <label class="form-label">Créneaux disponibles</label>
      <div id="slots-container">
        <div class="text-muted">Choisissez une date pour voir les créneaux.</div>
      </div>
    </div>

    <!-- Formulaire de réservation -->
    <h3 class="h5 mt-4">Vos informations</h3>

    <%= form_with url: bookings_path, method: :post, local: true, class: "card p-3" do |f| %>
      <%= f.hidden_field :service_id, value: @service.id %>
      <%= f.hidden_field :start_time, id: "booking_start_time" %>
      <%= f.hidden_field :end_time, id: "booking_end_time" %>

      <div class="mb-3">
        <%= f.label :customer_name, "Nom", class: "form-label" %>
        <%= f.text_field :customer_name, class: "form-control", required: true %>
      </div>

      <div class="mb-3">
        <%= f.label :customer_email, "Email", class: "form-label" %>
        <%= f.email_field :customer_email, class: "form-control", required: true %>
      </div>

      <div class="mb-2" id="selected-slot-summary" style="display:none;">
        <small class="text-success">
          Créneau sélectionné :
          <span id="selected-slot-label"></span>
        </small>
      </div>

      <div class="d-grid">
        <%= f.submit "Confirmer la réservation", class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  (function() {
    const serviceId = <%= @service.id %>;
    const availabilityUrlTemplate = "/services/" + serviceId + "/availability?date=";

    const dateInput = document.getElementById("booking-date");
    const slotsContainer = document.getElementById("slots-container");
    const startField = document.getElementById("booking_start_time");
    const endField = document.getElementById("booking_end_time");
    const summaryBlock = document.getElementById("selected-slot-summary");
    const summaryLabel = document.getElementById("selected-slot-label");

    // Préselectionne la date du jour
    const today = new Date();
    dateInput.value = today.toISOString().slice(0, 10);

    dateInput.addEventListener("change", function() {
      loadSlots(this.value);
    });

    // Charger les slots pour la date initiale
    loadSlots(dateInput.value);

    function loadSlots(dateStr) {
      slotsContainer.innerHTML = "<div class='text-muted'>Chargement...</div>";

      fetch(availabilityUrlTemplate + encodeURIComponent(dateStr))
        .then(response => response.json())
        .then(data => {
          renderSlots(data.slots, dateStr);
        })
        .catch(() => {
          slotsContainer.innerHTML = "<div class='text-danger'>Erreur lors du chargement des créneaux.</div>";
        });
    }

    function renderSlots(slots, dateStr) {
      if (!slots || slots.length === 0) {
        slotsContainer.innerHTML = "<div class='text-muted'>Aucun créneau disponible pour cette date.</div>";
        return;
      }

      const wrapper = document.createElement("div");
      wrapper.className = "d-flex flex-wrap gap-2";

      slots.forEach(slot => {
        const start = new Date(slot.start);
        const end   = new Date(slot.end);

        const label = formatTime(start) + " - " + formatTime(end);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-outline-primary btn-sm";
        btn.textContent = label;

        btn.addEventListener("click", () => {
          // maj champs hidden
          startField.value = slot.start;
          endField.value = slot.end;

          // feedback visuel
          Array.from(wrapper.children).forEach(b => b.classList.remove("active"));
          btn.classList.add("active");

          summaryLabel.textContent = dateStr + " · " + label;
          summaryBlock.style.display = "block";
        });

        wrapper.appendChild(btn);
      });

      slotsContainer.innerHTML = "";
      slotsContainer.appendChild(wrapper);
    }

    function formatTime(date) {
      const h = String(date.getHours()).padStart(2, "0");
      const m = String(date.getMinutes()).padStart(2, "0");
      return h + ":" + m;
    }
  })();
</script>
