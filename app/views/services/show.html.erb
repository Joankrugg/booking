<div class="container py-5">

  <div class="row mb-4">
    <% if @service.photo.attached? %>
      <%= image_tag @service.photo, height: 180, width: 320, crop: :fill, class: "img-fluid rounded shadow-sm" %>
    <% end %>
    <div class="col-md-7">
      <h1 class="fw-bold text-primary"><%= @service.name %></h1>
      <p class="text-muted fs-5"><%= @service.description %></p>

      <p class="fw-bold fs-4 text-dark">
        <%= @service.price_euros %> € 
        <span class="text-muted fs-6">
          • <%= @service.duration_minutes %> min
        </span>
      </p>
    </div>
  </div>

  <hr class="my-4">

  <div class="row">
    <div class="col-md-4">
      <label class="form-label fw-semibold">Choisir une date</label>
      <input type="date" id="booking-date" class="form-control shadow-sm">
    </div>

    <div class="col-md-8">
      <h4 class="fw-bold mb-3">Créneaux disponibles</h4>
      <div id="slots-container" class="p-2"></div>
    </div>
  </div>

  <hr class="my-4">

  <h3 class="fw-bold mb-3">Vos informations</h3>
  <%= form_with model: [@service, Booking.new], local: true do |f| %>


    <%= f.hidden_field :service_id, value: @service.id %>
    <%= f.hidden_field :start_time, id: "booking_start_time" %>
    <%= f.hidden_field :end_time, id: "booking_end_time" %>

    <div class="mb-3">
      <%= f.label :customer_name, "Nom complet", class: "form-label fw-semibold" %>
      <%= f.text_field :customer_name, class: "form-control shadow-sm", required: true %>
    </div>

    <div class="mb-3">
      <%= f.label :customer_email, "Email", class: "form-label fw-semibold" %>
      <%= f.email_field :customer_email, class: "form-control shadow-sm", required: true %>
    </div>

    <div class="mb-3 text-success fw-semibold" id="selected-slot-summary" style="display:none;">
      Créneau sélectionné :
      <span id="selected-slot-label"></span>
    </div>

    <div class="d-grid">
      <%= f.submit "Réserver ce créneau", class: "btn btn-primary btn-lg" %>
      <% if @booking&.errors&.any? %>
        <div class="alert alert-danger mt-3">
          <strong>Impossible de valider :</strong>
          <ul class="mb-0">
            <% @booking.errors.full_messages.each do |msg| %>
              <li><%= msg %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>

  <% end %>
</div>


<script>
(function() {
  const serviceId = <%= @service.id %>;

  const prefillDate  = "<%= @prefill_date || '' %>";
  const prefillStart = "<%= @prefill_start || '' %>";

  const availabilityUrlTemplate = "/services/" + serviceId + "/availability?date=";

  const dateInput      = document.getElementById("booking-date");
  const slotsContainer = document.getElementById("slots-container");
  const startField     = document.getElementById("booking_start_time");
  const endField       = document.getElementById("booking_end_time");
  const summaryBlock   = document.getElementById("selected-slot-summary");
  const summaryLabel   = document.getElementById("selected-slot-label");

  // ----------------------------
  // 1) Préselection de la DATE
  // ----------------------------
  if (prefillDate !== "") {
    dateInput.value = prefillDate;
  } else {
    const today = new Date();
    dateInput.value = today.toISOString().slice(0, 10);
  }

  // Charger les slots pour la date courante
  loadSlots(dateInput.value);

  dateInput.addEventListener("change", function() {
    loadSlots(this.value);
  });

  // ----------------------------
  // 2) Charger & rendre les créneaux
  // ----------------------------
  function loadSlots(dateStr) {
    slotsContainer.innerHTML = "<div class='text-muted'>Chargement...</div>";

    fetch(availabilityUrlTemplate + encodeURIComponent(dateStr))
      .then(response => response.json())
      .then(data => {
        renderSlots(data.slots || [], dateStr);
      })
      .catch(() => {
        slotsContainer.innerHTML = "<div class='text-danger'>Erreur lors du chargement des créneaux.</div>";
      });
  }

  function renderSlots(slots, dateStr) {
    if (!slots || slots.length === 0) {
      slotsContainer.innerHTML = "<div class='text-muted'>Aucun créneau disponible pour cette date.</div>";
      return;
    }

    const wrapper = document.createElement("div");
    wrapper.className = "d-flex flex-wrap gap-2";

    slots.forEach(slot => {
      const start = new Date(slot.start);
      const end   = new Date(slot.end);
      const label = formatTime(start) + " - " + formatTime(end);

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn btn-outline-primary btn-sm";
      btn.textContent = label;

      // ----------------------------
      // 3) AUTO-SÉLECTION si params[:start]
      // ----------------------------
      if (prefillStart && slot.start === prefillStart) {
        btn.classList.add("active");

        startField.value = slot.start;
        endField.value   = slot.end;

        summaryLabel.textContent = `${dateStr} · ${label}`;
        summaryBlock.style.display = "block";
      }

      btn.addEventListener("click", () => {
        Array.from(wrapper.children).forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        startField.value = slot.start;
        endField.value   = slot.end;

        summaryLabel.textContent = dateStr + " · " + label;
        summaryBlock.style.display = "block";
      });

      wrapper.appendChild(btn);
    });

    slotsContainer.innerHTML = "";
    slotsContainer.appendChild(wrapper);
  }

  function formatTime(date) {
    const h = String(date.getHours()).padStart(2, "0");
    const m = String(date.getMinutes()).padStart(2, "0");
    return h + ":" + m;
  }
})();
</script>

